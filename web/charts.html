<!doctype html>
<html>

<head>
    <title>Charts</title>
    <script src="scripts/moment.min.js"></script>
    <script src="scripts/Chart.min.js"></script>
    <link href="style.css" rel="stylesheet">
    <script src="script.js"></script>
</head>

<body>
    <h1>Hardware Statistics</h1>
    <script>
        var dataSource = {
            values: [],
            byteToGB: function(bytes){
                return bytes / 1024 / 1024 / 1024;
            },
            getValues: function () {
                if (this.values.length > 0) {
                    return this.values;
                }
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function () {
                    if (this.readyState == 4 && this.status == 200) {
                        dataSource.values = JSON.parse(this.responseText);
                    }
                };
                xhttp.open("GET", "/getdata", false);
                xhttp.send();
                return this.values;
            },
            getRAMUsage: function () {
                var ret = [];
                var values = this.getValues();
                for (var i = 0; i < values.length; i++) {
                    var obj = values[i];
                    var unixTime = moment(obj.timestamp, "YYYY-MM-DD HH:mm:ss").valueOf();
                    ret.push({ t: unixTime, y: obj.ram.used / 1024 / 1024 / 1024 });
                }
                return ret;
            },
            getRAMData: function () {
                var ret = {};
                var objArr = this.getValues();
                var current = objArr[objArr.length - 1];
                ret.data = [current.ram.free / 1024 / 1024 / 1024, current.ram.used / 1024 / 1024 / 1024];
                ret.max = current.ram.total / 1024 / 1024 / 1024;
                return ret;
            },
            getCPUData: function () {
                var ret = [];
                var objArr = this.getValues();
                for (var i = 0; i < objArr.length; i++) {
                    var obj = objArr[i];
                    var unixTime = moment(obj.timestamp, "YYYY-MM-DD HH:mm:ss").valueOf();
                    ret.push({ t: unixTime, y: obj.cpu.utilization });
                }
                return ret;
            },
            getPartitionUsage: function(){
                var ret = [];
                var objArr = this.getValues();
                for (var i = 0; i < objArr.length; i++) {
                    var obj = objArr[i];
                    var unixTime = moment(obj.timestamp, "YYYY-MM-DD HH:mm:ss").valueOf();
                    ret.push({ t: unixTime, y: this.byteToGB(obj.partitions[0].used) });
                }
                return ret;
            },
            getPartitionData: function(){
                var ret = {};
                var objArr = this.getValues();
                var current = objArr[objArr.length - 1];
                ret.data = [current.partitions[0].free / 1024 / 1024 / 1024, current.partitions[0].used / 1024 / 1024 / 1024];
                ret.max = current.partitions[0].total / 1024 / 1024 / 1024;
                return ret;
            }
        }

        var ramDiv = createDiv("ram");
        generateChart(createChartWrapper("chart1", "all lineChartX", ramDiv), "RAM usage", "RAM in GB", "GB", dataSource.getRAMUsage());
        var ramData = dataSource.getRAMData();
        generatePieChart(createChartWrapper("pie-chart", "all pieChart", ramDiv), "RAM usage", "RAM in GB", "GB", ["Free", "Used"], ["green", "orange"], ramData.data, ramData.max);
        
        generateChart(createChartWrapper("chart2", "all lineChart"), "CPU usage", "CPU in %", "%", dataSource.getCPUData());

        var partitionDiv = createDiv("partitions")
        generateChart(createChartWrapper("test", "all lineChartX", partitionDiv), "Memory usage", "Memory in GB", "GB", dataSource.getPartitionUsage());
        var pData = dataSource.getPartitionData();
        generatePieChart(createChartWrapper("pieChartX", "all pieChart", partitionDiv), "Memory usage", "Memory in GB", "GB", ["Free", "Used"], ["green", "red"], pData.data, pData.max);


        function createDiv(id){
            //TODO: sub headlines
            var divEl = document.createElement("div");
            document.getElementsByTagName("body")[0].appendChild(divEl);
            divEl.id = id;
            divEl.style.display = "flex";
            return divEl;
        }

        function createChartWrapper(id, classes, parent){
            var target = parent || document.getElementsByTagName("body")[0];

            var divEl = document.createElement("div");
            divEl.classList = classes;
            target.appendChild(divEl);
            var canvasEl = document.createElement("canvas");
            canvasEl.id = id;
            divEl.appendChild(canvasEl);
            return id;
        }
    </script>
</body>

</html>